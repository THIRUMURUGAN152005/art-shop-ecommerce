<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art Shop - Complete Store</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <script>
        const user = localStorage.getItem('user') || sessionStorage.getItem('user');
        if (!user) window.location.href = 'login.html';
    </script>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo">ðŸŽ¨ Art Shop</div>
            <ul class="nav-menu">
                <li><a href="#gallery">Gallery</a></li>
                <li><a href="#cart">Cart (<span id="cart-count">0</span>)</a></li>
                <li><a href="#orders">My Orders</a></li>
                <li><button onclick="logout()" class="btn btn-secondary" style="padding: 8px 20px;">Logout</button></li>
            </ul>
        </div>
    </nav>

    <!-- Gallery Section -->
    <section id="gallery" class="gallery-section">
        <div class="container">
            <h2>Art Gallery</h2>
            <div id="artworks-container" class="artworks-grid">
                <p>Loading artworks...</p>
            </div>
        </div>
    </section>

    <!-- Cart Section -->
    <section id="cart" class="cart-section">
        <div class="container">
            <h2>Shopping Cart</h2>
            <div id="cart-items" class="cart-items">
                <p>Your cart is empty.</p>
            </div>
            <div class="cart-summary">
                <p>Total Items: <span id="total-items">0</span></p>
                <p>Total Price: $<span id="total-price">0.00</span></p>
            </div>
            
            <!-- Order Form -->
            <div id="order-form-section" style="margin-top: 40px; display: none;">
                <h3>Complete Your Order</h3>
                <form id="checkout-form" class="checkout-form">
                    <div class="form-group">
                        <label for="fullName">Full Name</label>
                        <input type="text" id="fullName" name="fullName" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="address">Address</label>
                        <input type="text" id="address" name="address" required>
                    </div>
                    <div class="form-group">
                        <label for="city">City</label>
                        <input type="text" id="city" name="city" required>
                    </div>
                    <div class="form-group">
                        <label for="postalCode">Postal Code</label>
                        <input type="text" id="postalCode" name="postalCode" required>
                    </div>
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <input type="text" id="cardNumber" name="cardNumber" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Place Order</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Orders Section -->
    <section id="orders" class="orders-section">
        <div class="container">
            <h2>My Orders</h2>
            <div id="orders-list">
                <p>Loading orders...</p>
            </div>
        </div>
    </section>

    <script>
        // API Base URL
        const API_BASE_URL = '/api';
        let cart = JSON.parse(localStorage.getItem('cart')) || [];

        // Load artworks
        async function loadArtworks() {
            try {
                const response = await fetch(`${API_BASE_URL}/artworks`);
                const artworks = await response.json();
                const container = document.getElementById('artworks-container');
                container.innerHTML = '';
                artworks.forEach(artwork => {
                    const card = document.createElement('div');
                    card.className = 'artwork-card';
                    card.innerHTML = `
                        <img src="${artwork.imageUrl}" alt="${artwork.title}" class="artwork-image">
                        <div class="artwork-details">
                            <h3 class="artwork-title">${artwork.title}</h3>
                            <p class="artwork-price">$${artwork.price.toFixed(2)}</p>
                            <p class="artwork-description">${artwork.description}</p>
                            <button class="btn btn-primary" onclick="addToCart('${artwork.id}', '${artwork.title}', ${artwork.price})">Add to Cart</button>
                        </div>
                    `;
                    container.appendChild(card);
                });
            } catch (error) {
                console.error('Error:', error);
            }
        }

        // Add to cart
        function addToCart(id, title, price) {
            const existing = cart.find(item => item.id === id);
            if (existing) {
                existing.quantity += 1;
            } else {
                cart.push({ id, title, price, quantity: 1 });
            }
            saveCart();
            alert(`${title} added to cart!`);
        }

        // Save cart
        function saveCart() {
            localStorage.setItem('cart', JSON.stringify(cart));
            updateCartCount();
            displayCart();
        }

        // Update cart count
        function updateCartCount() {
            const total = cart.reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cart-count').textContent = total;
        }

        // Display cart
        function displayCart() {
            const container = document.getElementById('cart-items');
            const form = document.getElementById('order-form-section');
            
            if (cart.length === 0) {
                container.innerHTML = '<p>Your cart is empty.</p>';
                form.style.display = 'none';
                document.getElementById('total-items').textContent = '0';
                document.getElementById('total-price').textContent = '0.00';
                return;
            }

            form.style.display = 'block';
            let total = 0;
            let items = 0;
            container.innerHTML = '';
            
            cart.forEach(item => {
                items += item.quantity;
                total += item.price * item.quantity;
                const div = document.createElement('div');
                div.className = 'cart-item';
                div.innerHTML = `
                    <div><strong>${item.title}</strong><br>$${item.price.toFixed(2)} each</div>
                    <div>
                        <input type="number" value="${item.quantity}" min="1" onchange="updateQuantity('${item.id}', this.value)" style="width: 60px; padding: 5px;">
                    </div>
                    <div><strong>$${(item.price * item.quantity).toFixed(2)}</strong></div>
                    <button class="btn btn-danger" onclick="removeFromCart('${item.id}')">Remove</button>
                `;
                container.appendChild(div);
            });

            document.getElementById('total-items').textContent = items;
            document.getElementById('total-price').textContent = total.toFixed(2);
            
            // Auto-fill user data
            const user = JSON.parse(localStorage.getItem('user') || sessionStorage.getItem('user'));
            if (user) {
                document.getElementById('email').value = user.email;
                document.getElementById('fullName').value = user.firstName + ' ' + user.lastName;
            }
        }

        // Update quantity
        function updateQuantity(id, qty) {
            const item = cart.find(i => i.id === id);
            if (item) {
                item.quantity = Math.max(1, parseInt(qty));
                saveCart();
            }
        }

        // Remove from cart
        function removeFromCart(id) {
            cart = cart.filter(item => item.id !== id);
            saveCart();
        }

        // Handle checkout
        async function handleCheckout(event) {
            event.preventDefault();
            if (cart.length === 0) {
                alert('Cart is empty!');
                return;
            }

            const formData = new FormData(event.target);
            const order = {
                fullName: formData.get('fullName'),
                email: formData.get('email'),
                address: formData.get('address'),
                city: formData.get('city'),
                postalCode: formData.get('postalCode'),
                cardNumber: formData.get('cardNumber'),
                items: cart,
                totalAmount: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0)
            };

            try {
                const response = await fetch(`${API_BASE_URL}/orders`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(order)
                });
                const result = await response.json();
                alert('Order placed successfully! Order ID: ' + result.id);
                cart = [];
                saveCart();
                event.target.reset();
                loadAllOrders();
                document.getElementById('orders').scrollIntoView({ behavior: 'smooth' });
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to place order');
            }
        }

        // Load orders
        async function loadAllOrders() {
            try {
                const response = await fetch('/api/orders');
                const orders = await response.json();
                const container = document.getElementById('orders-list');
                
                if (!orders || orders.length === 0) {
                    container.innerHTML = '<p>No orders yet. Start shopping!</p>';
                    return;
                }
                
                container.innerHTML = orders.map(order => `
                    <div style="background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                        <h3>Order #${order.id.substring(0, 8)}</h3>
                        <p><strong>Date:</strong> ${new Date(order.createdAt).toLocaleDateString()}</p>
                        <p><strong>Customer:</strong> ${order.fullName}</p>
                        <p><strong>Email:</strong> ${order.email}</p>
                        <p><strong>Address:</strong> ${order.address}, ${order.city}, ${order.postalCode}</p>
                        <h4>Items:</h4>
                        ${order.items.map(item => `
                            <div style="padding: 10px; border-bottom: 1px solid #eee;">
                                ${item.title} x ${item.quantity} = $${(item.price * item.quantity).toFixed(2)}
                            </div>
                        `).join('')}
                        <p style="text-align: right; font-size: 20px; font-weight: bold; color: #667eea; margin-top: 10px;">
                            Total: $${order.totalAmount.toFixed(2)}
                        </p>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('orders-list').innerHTML = '<p>Error loading orders</p>';
            }
        }

        // Logout
        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadArtworks();
            displayCart();
            loadAllOrders();
            document.getElementById('checkout-form').addEventListener('submit', handleCheckout);
        });
    </script>
</body>
</html>
